<ui:composition template="/templates/template.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:define name="content">

		<div class="col-md-12">
			<h3>Inventario de #{productsController.inventory.client.name}</h3>
		</div>

		<h:form>
			<p:messages id="messages" showDetail="false" autoUpdate="true"
				closable="true" />
		</h:form>
		<h:form id="productsForm">
			<p:dataTable var="product" value="#{productsController.products}"
				selectionMode="single"
				selection="#{productsController.productToEdit}"
				widgetVar="productsTable" paginator="true" rows="10"
				id="productsDataTable" lazy="true" rowsPerPageTemplate="10,20,50"
				tableStyle="table-layout: auto;">
				<p:ajax event="rowSelect" process="productsForm:productsDataTable"
					listener="#{productsController.productSelected}"
					update=":dialogForm"
					oncomplete="PF('productDetailsDialog').show();" />
				<f:facet name="header">
					<p:commandButton rendered="#{productsController.renderActions}"
						value="Agregar Producto" styleClass="btn btn-primary"
						actionListener="#{productsController.addProduct()}"
						update=":dialogForm" process="@this"
						oncomplete="PF('productDetailsDialog').show();">
					</p:commandButton>
					<p:commandButton
						actionListener="#{productsController.getDeliveriesLink()}"
						value="Ver Movimientos" styleClass="btn btn-primary" />

					<p:commandButton rendered="#{productsController.renderActions}"
						actionListener="#{productsController.getUploadRequisitionLink()}"
						value="Crear Requisicion" styleClass="btn btn-primary" />

					<h:commandLink styleClass="btn btn-default">
						Exportar Excel
						<p:dataExporter type="xls" target="productsDataTable"
							fileName="inventario" />
					</h:commandLink>

					<h:commandLink styleClass="btn btn-default">
						Exportar PDF
						<p:dataExporter type="pdf" target="productsDataTable"
							fileName="inventario" />
					</h:commandLink>
				</f:facet>
				<f:facet name="footer">
					<p:commandButton onclick="PF('productsTable').clearFilters();"
						value="Limpiar Filtros" process="productsForm:productsDataTable" />
				</f:facet>
				<p:column headerText="Codigo" filterBy="#{product.code}"
					sortBy="#{product.code}">
					<h:outputText value="#{product.code}" />
				</p:column>
				<p:column headerText="Marca" filterBy="#{product.brand}"
					sortBy="#{product.brand}">
					<h:outputText value="#{product.brand}" />
				</p:column>
				<p:column headerText="Material" filterBy="#{product.material}"
					sortBy="#{product.material}">
					<h:outputText value="#{product.material}" />
				</p:column>
				<c:forEach var="storehouse"
					items="#{productsController.storehouses}">
					<p:column headerText="#{storehouse.name}">
						<h:outputText
							value="#{product.getStorehouseQuantity(storehouse.name)}" />
					</p:column>
					<p:column headerText="Dias en Bodega">
						<h:outputText
							value="#{product.getStorehouseProduct(storehouse.name).daysInStorehouse}" />
					</p:column>
				</c:forEach>
				<p:column headerText="Costo Unit"
					rendered="#{productsController.inventory.unitCost}">
					<h:outputText value="#{product.unitCost}">
						<f:convertNumber type="currency" currencySymbol="$" />
					</h:outputText>
				</p:column>
				<p:column headerText="Costo Total"
					rendered="#{productsController.inventory.unitCost}">
					<h:outputText value="#{product.totalCost}">
						<f:convertNumber type="currency" currencySymbol="$" />
					</h:outputText>
				</p:column>
				<p:column headerText="Posicion"
					rendered="#{productsController.inventory.rackPositions}">
					<h:outputText value="#{product.positionsOnRackAsString}" />
				</p:column>
				<p:column headerText="Foto" exportable="false">
					<p:graphicImage style="max-width:75px; max-height:80px;"
						value="../uploadedImages/#{product.photo.directory}/#{product.photo.name}" />
					<h:outputText value="No hay Foto"
						rendered="#{not productsController.isPhotoSet(product) and not productsController.renderActions}" />
				</p:column>
				<p:column headerText="Movimientos" exportable="false">
					<p:commandLink
						action="#{productsController.getProductDeliveriesLink(product)}"
						value="Ver Movimientos" styleClass="btn btn-default"
						process="@this" />
				</p:column>
			</p:dataTable>

		</h:form>
		<h:form id="dialogForm">

			<p:remoteCommand name="hideDetails"
				action="#{productsController.reset()}" global="true"
				update=":productsForm:productsDataTable" autoRun="false" />

			<p:dialog widgetVar="productDetailsDialog" id="productDetailsDialog"
				rendered="#{productsController.showProductDetail}" resizable="false"
				header="Producto: #{productsController.productToEdit.code}"
				onHide="hideDetails();" width="750" modal="true">
				<p:messages autoUpdate="true" closable="true" />
				<p:panel style="width:150px; float:left;"
					id="detailsDialogPhotoPanel">
					<p:graphicImage style="max-width:150px; max-height:200px;"
						value="../uploadedImages/#{productsController.productToEdit.photo.directory}/#{productsController.productToEdit.photo.name}" />
					<p:fileUpload uploadLabel="Subir" cancelLabel="Cancelar"
						auto="true"
						label="Seleccionar" rendered="#{productsController.renderActions}"
						fileUploadListener="#{photoUploadController.uploadFile}"
						update="@form:detailsDialogPhotoPanel">
					</p:fileUpload>
				</p:panel>
				<p:panel style="width:550px; float:left;">
					<p:panelGrid>
						<p:row>
							<p:column>
								<h:outputLabel value="Material" />
							</p:column>
							<p:column colspan="3">
								<h:outputText rendered="#{not productsController.renderActions}"
									value="#{productsController.productToEdit.material}" />
								<h:inputText rendered="#{productsController.renderActions}"
									style="width:100%;"
									value="#{productsController.productToEdit.material}" />
							</p:column>
						</p:row>
						<p:row>
							<p:column>
								<h:outputLabel value="Codigo" />
							</p:column>
							<p:column>
								<h:outputText
									rendered="#{not productsController.renderAdminActions}"
									value="#{productsController.productToEdit.code}" />
								<h:inputText rendered="#{productsController.renderAdminActions}"
									value="#{productsController.productToEdit.code}" />
							</p:column>
							<p:column>
								<h:outputLabel value="Marca" />
							</p:column>
							<p:column>
								<h:outputText rendered="#{not productsController.renderActions}"
									value="#{productsController.productToEdit.brand}" />
								<h:inputText rendered="#{productsController.renderActions}"
									value="#{productsController.productToEdit.brand}" />
							</p:column>
						</p:row>
						<p:row>
							<p:column colspan="4">
								<h:outputLabel value="Cantidades en Bodegas:" />
							</p:column>
						</p:row>
						<p:row>
							<p:column colspan="4" style="padding:0;">
								<p:dataTable
									value="#{productsController.productToEdit.quantities}"
									var="pbs" style="margin:0;">
									<p:column headerText="Bodega">
										<h:outputLabel value="#{pbs.storehouse.name}" />
									</p:column>
									<p:column headerText="Cantidad">
										<h:outputText
											rendered="#{not productsController.renderAdminActions}"
											value="#{pbs.quantity}" />
										<h:inputText
											rendered="#{productsController.renderAdminActions}"
											value="#{pbs.quantity}" />
									</p:column>
									<p:column headerText="Dias">
										<h:outputText value="#{pbs.daysInStorehouse}" />
									</p:column>
									<p:column headerText="Costo"
										rendered="#{productsController.inventory.unitCost}">
										<h:outputText value="#{pbs.totalCost}" />
									</p:column>
								</p:dataTable>
							</p:column>
						</p:row>
						<p:row rendered="#{productsController.inventory.unitCost}">
							<p:column>
								<h:outputLabel value="Costo Unitario" />
							</p:column>
							<p:column>
								<h:outputText rendered="#{not productsController.renderActions}"
									value="#{productsController.productToEdit.unitCost}" />
								<h:inputText rendered="#{productsController.renderActions}"
									value="#{productsController.productToEdit.unitCost}" />
							</p:column>
							<p:column>
								<h:outputLabel value="Costo Total" />
							</p:column>
							<p:column>
								<h:outputText
									value="#{productsController.productToEdit.totalCost}" />
							</p:column>
						</p:row>
						<p:row rendered="#{productsController.inventory.rackPositions}">
							<p:column>
								<h:outputLabel value="Posiciones en Rack: " />
							</p:column>
							<p:column colspan="3">
								<h:outputText
									value="#{productsController.productToEdit.positionsOnRackAsString}" />
							</p:column>
						</p:row>
						<p:row
							rendered="#{not productsController.newProduct and productsController.renderActions}">
							<p:column>
								<h:outputLabel value="Razon de Cambio: " />
							</p:column>
							<p:column colspan="3">
								<h:inputText value="#{productsController.changeReason}" />
							</p:column>
						</p:row>
						<p:row rendered="#{productsController.renderActions}">
							<p:column colspan="2">
								<h:outputText value="" />
							</p:column>
							<p:column>
								<p:commandButton value="Guardar" update="@form:detailsDialogPhotoPanel" process="@form"
									actionListener="#{productsController.save()}" />
							</p:column>
							<p:column>
								<p:commandButton value="Cancelar" update="@none" process="@this"
									onclick="PF('productDetailsDialog').hide();" />
							</p:column>
						</p:row>
					</p:panelGrid>
				</p:panel>
			</p:dialog>
		</h:form>
	</ui:define>
</ui:composition>
