<ui:composition template="/templates/template.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:define name="content">

		<div class="col-md-12">
			<h3>Inventario de #{productsController.inventory.client.name}</h3>
		</div>

		<h:form>
			<p:messages id="messages" showDetail="false" autoUpdate="true"
				closable="true" />
		</h:form>
		<h:form id="productsForm">
			<p:dataTable var="product" value="#{productsController.products}"
				selectionMode="single"
				selection="#{productsController.productToEdit}"
				widgetVar="productsTable" paginator="true" rows="10"
				id="productsDataTable" lazy="true"
				paginatorTemplate="{RowsPerPageDropdown} {FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
				tableStyle="table-layout: auto;" rowsPerPageTemplate="10,20,50,100">
				<p:ajax event="rowSelect" process="productsForm:productsDataTable"
					listener="#{productsController.productSelected}" update="@form" />
				<f:facet name="header">
					<p:commandButton rendered="#{productsController.renderActions}"
						value="Agregar Producto" styleClass="btn btn-primary"
						actionListener="#{productsController.showAddProduct()}">
					</p:commandButton>
					<p:commandButton
						actionListener="#{productsController.getDeliveriesLink()}"
						value="Ver Movimientos" styleClass="btn btn-primary" />

					<p:commandButton rendered="#{productsController.renderActions}"
						actionListener="#{productsController.getUploadRequisitionLink()}"
						value="Crear Requisicion" styleClass="btn btn-primary" />

					<h:commandLink styleClass="btn btn-default">
						Exportar Excel
						<p:dataExporter type="xls" target="productsDataTable"
							fileName="inventario" />
					</h:commandLink>

					<h:commandLink styleClass="btn btn-default" >
						Exportar PDF
						<p:dataExporter type="pdf" target="productsDataTable"
							fileName="inventario" />
					</h:commandLink>
				</f:facet>
				<f:facet name="footer">
					<p:commandButton onclick="PF('productsTable').clearFilters();"
						value="Limpiar Filtros" process="productsForm:productsDataTable" />
				</f:facet>
				<p:column headerText="Codigo" filterBy="#{product.code}"
					sortBy="#{product.code}">
					<h:outputText value="#{product.code}" />
				</p:column>
				<p:column headerText="Marca" filterBy="#{product.brand}"
					sortBy="#{product.brand}">
					<h:outputText value="#{product.brand}" />
				</p:column>
				<p:column headerText="Material" filterBy="#{product.material}"
					sortBy="#{product.material}">
					<h:outputText value="#{product.material}" />
				</p:column>
				<c:forEach var="storehouse"
					items="#{productsController.storehouses}">
					<p:column headerText="#{storehouse.name}">
						<h:outputText
							value="#{productsController.getQuantityFor(storehouse, product)}" />
					</p:column>
					<p:column headerText="Dias en Bodega">
						<h:outputText
							value="#{productsController.getDaysInStorehouseFor(storehouse, product)}" />
					</p:column>
				</c:forEach>
				<p:column headerText="Costo Unit"
					rendered="#{productsController.inventory.unitCost}">
					<h:outputText value="#{product.unitCost}">
						<f:convertNumber type="currency" currencySymbol="$" />
					</h:outputText>
				</p:column>
				<p:column headerText="Costo Total"
					rendered="#{productsController.inventory.unitCost}">
					<h:outputText value="#{productsController.getTotalCost(product)}">
						<f:convertNumber type="currency" currencySymbol="$" />
					</h:outputText>
				</p:column>
				<p:column headerText="Posicion"
					rendered="#{productsController.inventory.rackPositions}">
					<h:outputText value="#{productsController.getPositionsOnRackString(product)}" />
				</p:column>
				<p:column headerText="Foto" exportable="false">
					<h:commandButton
						rendered="#{productsController.isPhotoSet(product)}"
						image="/uploadedImages/#{product.photo.directory}/#{product.photo.name}"
						style="width: 75px">
						<f:ajax listener="#{productsController.showImage(product)}" />
					</h:commandButton>

					<p:commandButton value="Subir Foto"
						rendered="#{not productsController.isPhotoSet(product) and productsController.renderActions}"
						onclick="PF('uploadPhotoDialog').show();">
						<f:setPropertyActionListener value="#{product}"
							target="#{photoUploadController.productToLink}" />
					</p:commandButton>

					<h:outputText value="No hay Foto"
						rendered="#{not productsController.isPhotoSet(product) and not productsController.renderActions}" />
				</p:column>
				<p:column headerText="Acciones" exportable="false"
					rendered="#{productsController.renderActions}">
					<p:commandButton value="Actualizar" rendered="#{productsController.renderAdminActions}"
						actionListener="#{productsController.showUpdateProduct(product)}"
						process="@this" />
					<p:commandButton value="Eliminar" rendered="#{productsController.renderAdminActions}"
						actionListener="#{productsController.deleteProduct(product)}"
						process="@this" update="@none" />
					<p:commandButton value="Asignar Posiciones" rendered="#{productsController.inventory.rackPositions}"
						actionListener="#{productsController.selectProductForPositions(product)}"
						process="@this" update="@none" />
				</p:column>
				<p:column headerText="Movimientos" exportable="false">
					<p:commandLink
						action="#{productsController.getProductDeliveriesLink(product)}"
						value="Ver Movimientos" styleClass="btn btn-default" process="@this" />
				</p:column>
			</p:dataTable>

			<p:remoteCommand name="hideDetails"
				action="#{productsController.productUnselected()}" global="true" />

			<p:dialog widgetVar="productDetailsDialog" id="productDetailsDialog"
				rendered="#{productsController.showProductDetail}" header="Producto: #{productsController.productToEdit.code}"
				onHide="hideDetails" width="680">
				<p:panel style="width:150px; float:left;">
					<p:graphicImage style="max-width:150px; max-height:200px;"
						value="../uploadedImages/#{productsController.productToEdit.photo.directory}/#{productsController.productToEdit.photo.name}" />
				</p:panel>
				<p:panel style="width:500px; float:left;">
					<p:panelGrid>
						<p:row>
							<p:column>
								<h:outputLabel value="Material" />
							</p:column>
							<p:column colspan="3">
								<h:outputText
									value="#{productsController.productToEdit.material}" />
							</p:column>
						</p:row>
						<p:row>
							<p:column>
								<h:outputLabel value="Codigo" />
							</p:column>
							<p:column>
								<h:outputText value="#{productsController.productToEdit.code}" />
							</p:column>
							<p:column>
								<h:outputLabel value="Marca" />
							</p:column>
							<p:column>
								<h:outputText value="#{productsController.productToEdit.brand}" />
							</p:column>
						</p:row>
						<c:forEach var="storehouse"
							items="#{productsController.storehouses}">
							<p:row>
								<p:column>
									<h:outputLabel value="#{storehouse.name}" />
								</p:column>
								<p:column>
									<h:outputText
										value="#{productsController.getQuantityFor(storehouse, productsController.productToEdit)}" />
								</p:column>
								<p:column>
									<h:outputLabel value="Dias Bodega" />
								</p:column>
								<p:column>
									<h:outputText
										value="#{productsController.getDaysInStorehouseFor(storehouse, productsController.productToEdit)}" />
								</p:column>
							</p:row>
						</c:forEach>
						<p:row rendered="#{productsController.inventory.unitCost}">
							<p:column>
								<h:outputLabel value="Costo Unitario" />
							</p:column>
							<p:column>
								<h:outputText
									value="#{productsController.productToEdit.unitCost}" />
							</p:column>
							<p:column>
								<h:outputLabel value="Costo Total" />
							</p:column>
							<p:column>
								<h:outputText
									value="#{productsController.getTotalCost(productsController.productToEdit)}" />
							</p:column>
						</p:row>
						<p:row rendered="#{productsController.inventory.rackPositions}">
							<p:column>
								<h:outputLabel value="Posiciones en Rack: " />
							</p:column>
							<p:column colspan="2">
								<h:outputText
									value="#{productsController.positionsOnRackString}" />
							</p:column>
							<p:column>
								<p:commandButton value="Editar posiciones"
									rendered="#{productsController.renderActions}"
									actionListener="#{productsController.calculatePositionsForProduct()}" 
									update="@form"
									process="@this"/>
							</p:column>
						</p:row>
					</p:panelGrid>
				</p:panel>
			</p:dialog>
			<p:dialog widgetVar="positionsDialog" id="positionsDialog" 
			rendered="#{productsController.inventory.rackPositions and productsController.renderActions and productsController.renderProductPositions}"
				header="Posiciones en Rack" modal="true">
				<p:panelGrid>
					<p:row>
						<p:column>
							<h:outputLabel value="Posiciones:" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[0]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[1]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[2]}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[3]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[4]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[5]}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[6]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[7]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[8]}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[9]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[10]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[11]}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[12]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[13]}" />
						</p:column>
						<p:column>
							<h:inputText
								value="#{productsController.currentProductPositions[14]}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<p:commandButton value="Guardar"
								actionListener="#{productsController.savePositions()}"
								update="@none" process="positionsDialog"
								onclick="PF('positionsDialog').hide();" />
						</p:column>
					</p:row>
				</p:panelGrid>
			</p:dialog>
			<p:dialog widgetVar="photoDialog" id="photoDialog"
				header="#{productsController.productToEdit.photo.title}"
				minHeight="400" minWidth="400" modal="true">
				<p:panelGrid>
					<p:row>
						<p:column>
							<p:graphicImage style="max-width:500px; max-height:650px;"
								value="../uploadedImages/#{productsController.productToEdit.photo.directory}/#{productsController.productToEdit.photo.name}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column>
							<h:outputText
								value="#{productsController.productToEdit.photo.description}" />
						</p:column>
					</p:row>
				</p:panelGrid>
			</p:dialog>
			<p:dialog widgetVar="uploadPhotoDialog" id="uploadPhotoDialog"
				rendered="#{productsController.renderActions}"
				header="Subir foto" minHeight="400" minWidth="400" modal="true">
				<p:fileUpload
					fileUploadListener="#{photoUploadController.uploadFile}"
					oncomplete="PF('uploadPhotoDialog').hide();" update="@form">
				</p:fileUpload>
			</p:dialog>
			<p:dialog widgetVar="updateProductDialog" id="updateProductDialog"
				rendered="#{productsController.renderActions and productsController.showEditProductDialog}"
				header="#{productsController.updateDialogCommand}" minHeight="400"
				minWidth="400" modal="true">
				<p:panelGrid>
					<p:column>
						<p:panel rendered="#{not productsController.isEditAction()}">
							<h:outputLabel value="Codigos Disponibles" />
							<p:dataList value="#{productsController.availablesCodes}"
								var="code">
								<p:commandButton icon="ui-icon-check"
									actionListener="#{productsController.selectAvailableCode(code)}"
									update="@none" process="@form" />
								<h:outputText value="#{code}" />
							</p:dataList>
						</p:panel>
					</p:column>
					<p:column>
						<p:panelGrid>
							<p:row>
								<p:column>
									<h:outputLabel value="Codigo" />
								</p:column>
								<p:column>
									<p:inputText value="#{productsController.productToEdit.code}"
										readonly="#{not productsController.renderAdminActions and productsController.editAction}" />
								</p:column>
								<p:column>
									<h:outputLabel value="Marca" />
								</p:column>
								<p:column>
									<p:inputText value="#{productsController.productToEdit.brand}" />
								</p:column>
							</p:row>
							<p:row>
								<p:column>
									<h:outputLabel value="Material" />
								</p:column>
								<p:column>
									<p:inputText
										value="#{productsController.productToEdit.material}" />
								</p:column>
								<p:column rendered="#{productsController.editAction}">
									<h:outputLabel value="Razon" />
								</p:column>
								<p:column rendered="#{productsController.editAction}">
									<p:inputText value="#{productsController.changeReason}"
										readonly="#{not productsController.renderAdminActions}" />
								</p:column>
							</p:row>
							<p:row rendered="#{productsController.inventory.unitCost}">
								<p:column>
									<h:outputLabel value="Costo Unitario" />
								</p:column>
								<p:column>
									<h:inputText
										value="#{productsController.productToEdit.unitCost}" />
								</p:column>
							</p:row>
							<p:row rendered="#{productsController.editAction}">
								<c:forEach var="storehouse"
									items="#{productsController.storehouses}">
									<p:column>
										<h:outputLabel value="#{storehouse.name}" />
									</p:column>
									<p:column>
										<h:inputText
											readonly="#{not productsController.renderAdminActions}"
											value="#{productsController.productToEdit.quantities.get(storehouse).quantity}" />
									</p:column>
								</c:forEach>
							</p:row>
							<p:row>
								<p:column>
									<p:commandButton
										actionListener="#{productsController.saveProduct()}"
										update="@form" process="@form:updateProductDialog"
										value="#{productsController.updateDialogCommand}"></p:commandButton>
								</p:column>
							</p:row>
						</p:panelGrid>
					</p:column>
				</p:panelGrid>
			</p:dialog>
		</h:form>
	</ui:define>
</ui:composition>
